# Student Model Distillation Strategy
**Goal:** Train a small, efficient "Student" model (e.g., Gemma 2B, Qwen 3B) to generate robust Behavior Trees (BTs) using only the initial state (Frame 0) and an instruction.

**Challenge:** The Student is "blind" to the future and has limited reasoning capacity. It risks "hallucinating" actions for objects not visible in Frame 0 or learning language biases instead of visual grounding.

**Solution:** Use **Privileged Information Distillation** with strict **Quality Assurance**. The Teacher uses future knowledge to build plans, but we filter data to ensure the Student only learns from grounded examples.

---

## 1. The Core Data Strategy: "Lossless Trace Logging"

We save the entire **Execution Trace** of the Teacher pipeline.

**Data Structure (JSONL Record):**
```json
{
  "episode_id": "ep_001",
  "instruction": "Put the blue can on the table",
  "student_image_path": "data/images/ep_001_frame0.jpg",      // Input for Student
  "teacher_image_path": "data/images/ep_001_contact.jpg",    // Input for Teacher (Privileged)
  "trace": {
    "feasibility": { "feasible": true, "reason": "..." },
    "frame0_check": {                                          // NEW: Critical Filter
       "visible_in_frame0": true,
       "reason": "Object clearly visible on table."
    },
    "scene_analysis": { ... },
    "steps": [ ... ]
  },
  "verdict": "ACCEPT"
}
```

---

## 2. Derived Datasets (The Curriculum)

### Dataset A: Structured Chain-of-Thought (S-CoT)
**Goal:** Ground language in vision and force logical planning steps.
**Constraint:** ONLY include samples where `trace.frame0_check.visible_in_frame0` is TRUE.

*   **Input:** Frame 0 + Instruction
*   **Target Output:**
    ```text
    <perception>
    Objects: Blue can (target), Red mug (obstacle).
    Relations: Can is close to mug (left side).
    </perception>
    <reasoning>
    Risk: Collision during grasp due to proximity.
    Strategy: Use fallback with precise approach.
    </reasoning>
    <code>
    <Sequence>
      <!-- Risk: Collision detected, using fallback -->
      <Fallback> ... </Fallback>
    </Sequence>
    </code>
    ```

### Dataset B: DPO (Robustness & Grounding)
**Goal:** Teach preference for Robustness and Syntax Correctness.
**Pairs:**
1.  **Robustness Pair:**
    *   *Chosen:* Output from `Robustness` agent (with retries/fallbacks).
    *   *Rejected:* Output from `Architect` (naive/linear).
2.  **Syntax/Logic Pair (Artificial):**
    *   *Chosen:* Valid BT.
    *   *Rejected:* Corrupted version (e.g., deleted `NAVIGATE_TO`, invalid params) generated by a script.

### Dataset C: Safety & Anti-Hallucination
**Goal:** Teach the model to say "NO" when it cannot see.
**Source:**
1.  Episodes where `Feasibility` = `False`.
2.  Episodes where `frame0_check.visible_in_frame0` = `False` (even if feasible later in the video).

*   **Input:** Frame 0 + Instruction
*   **Target Output:** "I cannot execute this task. Reason: The target object is not visible in the current view."

### Dataset D: Repair / Denoising (Syntax Hardening)
**Goal:** Teach the model to fix its own syntax errors (XML grammar).
**Method:** Take valid BTs, inject noise (typos, broken tags, missing IDs), and train the model to restore them.

*   **Input:** Broken XML + Instruction
*   **Target Output:** Corrected XML

---

## 3. Pipeline Changes Required

1.  **`generate_dataset.py`**:
    *   Implement **Lossless Trace Logging**.
    *   Save Frame 0 separately.

2.  **`teacher_loop.py`**:
    *   Accumulate all agent outputs.
    *   **CRITICAL:** Add a `Frame0Check` step (using `SceneAnalysis` or `Feasibility` agent) that explicitly asks: *"Is the target object visible and actionable in Frame 0 alone?"*

3.  **Prompts**:
    *   **`scene_analysis.md`**: Update to output structured perception (Objects, Relations) to feed the S-CoT.
    *   **`architect.md` / `robustness.md`**: Enforce XML comments for reasoning.

---

## 4. Training Workflow

1.  **Data Generation:** Run pipeline.
2.  **Filtering:** Discard SFT samples where Frame 0 is blank/occluded (move to Safety dataset).
3.  **Curriculum:**
    *   **Epoch 1-2:** Syntax Repair (Dataset D) + Safety (Dataset C).
    *   **Epoch 3-5:** S-CoT (Dataset A).
    *   **Epoch 6+:** DPO (Dataset B) for final polishing.
