######################################################################
# Dockerfile per fine-tuning VLM (SmolVLM, MiniGPT-4, ecc.)
# Compatibile con driver di Elysium: PyTorch 2.2.2 + CUDA 11.8
######################################################################

# 1) BASE: cu118 (compatibile con driver più vecchi)
FROM pytorch/pytorch:2.2.2-cuda11.8-cudnn8-devel

ARG USERNAME=battistini
ARG USER_UID=1170
ARG USER_GID=1170

# 2) Sistema base e tool
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        sudo git wget curl vim htop unzip ffmpeg \
        libsm6 libxext6 \
        libgl1 libglib2.0-0 \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# 3) Utente non-root (UID/GID coerenti)
RUN groupadd --gid $USER_GID $USERNAME && \
    useradd --uid $USER_UID --gid $USER_GID -m $USERNAME && \
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

USER $USERNAME
WORKDIR /home/$USERNAME/exp

# 4) Ambiente
ENV HF_HOME=/home/$USERNAME/.cache/huggingface \
    TRANSFORMERS_CACHE=/home/$USERNAME/.cache/huggingface \
    MPLCONFIGDIR=/home/$USERNAME/.cache/matplotlib \
    PYTHONUNBUFFERED=1 \
    TOKENIZERS_PARALLELISM=false \
    PIP_NO_CACHE_DIR=1 \
    PATH=/home/$USERNAME/.local/bin:$PATH

# 5) Requisiti Python
#    - NON reinstallare torch/vision/audio dal requirements (sono già cu118 nella base)
#    - Installa anche wandb
COPY requirements.txt /tmp/requirements.txt
RUN python -m pip install --upgrade pip && \
    awk '!/^(torch|torchvision|torchaudio)==/' /tmp/requirements.txt > /tmp/requirements_notorch.txt && \
    pip install --extra-index-url https://download.pytorch.org/whl/cu118 -r /tmp/requirements_notorch.txt && \
    pip install --no-cache-dir -U wandb && \
    pip cache purge

# 6) Sanity check toolchain
RUN python - <<'PY'
import torch
print("Torch:", torch.__version__, "CUDA:", torch.version.cuda, "CUDA available:", torch.cuda.is_available())
PY

CMD ["/bin/bash"]
