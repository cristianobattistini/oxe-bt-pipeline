######################################################################
# Dockerfile per fine-tuning VLM (SmolVLM, MiniGPT-4, ecc.)
# Compatibile con driver di Elysium: PyTorch 2.2.2 + CUDA 11.8
######################################################################

FROM pytorch/pytorch:2.2.2-cuda11.8-cudnn8-devel

ARG USERNAME=battistini
ARG USER_UID=1170
ARG USER_GID=1170

# Sistema base e tool
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        sudo git wget curl vim htop unzip ffmpeg \
        libsm6 libxext6 libgl1 libglib2.0-0 ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Utente non-root
RUN groupadd --gid $USER_GID $USERNAME && \
    useradd --uid $USER_UID --gid $USER_GID -m $USERNAME && \
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

USER $USERNAME
WORKDIR /home/$USERNAME/exp

# Ambiente
ENV HF_HOME=/home/$USERNAME/.cache/huggingface \
    TRANSFORMERS_CACHE=/home/$USERNAME/.cache/huggingface \
    MPLCONFIGDIR=/home/$USERNAME/.cache/matplotlib \
    PYTHONUNBUFFERED=1 \
    TOKENIZERS_PARALLELISM=false \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PATH=/home/$USERNAME/.local/bin:$PATH

# Requisiti Python:
# - Filtra torch/torchvision/torchaudio dal requirements (giÃ  presenti in base cu118)
# - Installa anche wandb
COPY requirements.txt /tmp/requirements.txt
RUN python -m pip install --upgrade pip && \
    awk '!/^(torch|torchvision|torchaudio)==/' /tmp/requirements.txt > /tmp/requirements_notorch.txt && \
    pip install --no-cache-dir --extra-index-url https://download.pytorch.org/whl/cu118 -r /tmp/requirements_notorch.txt && \
    pip install --no-cache-dir -U wandb

# Sanity check
RUN python - <<'PY'
import torch
print("Torch:", torch.__version__, "CUDA:", torch.version.cuda, "CUDA available:", torch.cuda.is_available())
PY

CMD ["/bin/bash"]
